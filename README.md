# cloudflare-worker-error-page
因为本网站运行在一个个人服务器上，所以每当我对服务器或网络设备进行维护时，都有可能影响到网站的可访问性。一旦网站无法访问，用户就只能看到官方默认的错误页。虽然那个页面很经典，但它有几个问题：
- 它不是很好看。
- 出现问题后用户无法向我联系或报告，导致问题无法及时被解决。
- 用户可能仅仅是输错了域名，却误以为服务器出现问题。（如未输入域名前缀）

虽然Cloudflare官方提供了“Custom Pages”功能，但这个需要订阅Business Plan ($200/month)才能解锁。对于个人开发者来说，为了修改一个页面支付这个成本显然不太划算。
不过我发现我可以使用Cloudflare Workers来“拦截”请求，然后将自定义错误页面发送给用户。
- **原理**：Worker运行在边缘节点，当它发现源站返回 5xx 错误（或直接连不上）时，不是直接把错误扔给用户，而是由Worker动态生成并返回一段预设好的HTML。
- **成本**：Worker每天有 10 万次免费额度，对于个人网站来说绰绰有余。

## 单文件化

这个方法中所有图片资源全部被转换为Base 64编码，直接内联写入HTML。
整个页面就只有一个HTML文件，不依赖任何外部请求，加载速度极快且极其稳定。

## 动态替换

在HTML模板中有两个占位符：
- {{ERROR_CODE}}：用于显示错误代码（如503）。
- {{ERROR_DESC}}：用于显示具体的说明。

Worker在拦截到错误响应后，会查表获取对应的文案，然后用正则填充这两个占位符。

## 部署注意事项

- 在DNS设置中，域名必须开启橙云模式，让Cloudflare代理所有流量，Worker才能生效并拦截。
- 在Worker路由配置中，记得同时覆盖子域名（\*.example.com/\*）和主域名（example.com/\*）。
- 设置路由时，在请求限制失败模式中选择失败时自动打开，这样在Worker代码有Bug或者额度用完时，Cloudflare会直接绕过Worker访问源站。
